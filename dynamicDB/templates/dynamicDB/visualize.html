<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualize Topics</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .button-container {
            text-align: center;
            margin: 20px 0;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 16px;
            margin: 0 10px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        #visualization {
            width: 100%;
            height: 700px;
            margin: 20px 0;
        }
        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }
        .node text {
            font: 14px sans-serif;
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 5px;
            pointer-events: none;
            max-width: 300px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 10;
            transition: opacity 0.3s;
        }
        .tooltip h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .tooltip p {
            margin: 5px 0;
            color: #555;
            font-size: 14px;
        }
        .legend {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .legend-item {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        .legend-circle {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .topic-color {
            background-color: #ff7f0e;
        }
        .chapter-color {
            background-color: #1f77b4;
        }
        
        /* Radial Dendrogram specific styles */
        .node-radial {
            cursor: pointer;
        }
        .node-radial circle {
            fill: #fff;
            stroke-width: 2px;
        }
        .node-radial text {
            font: 12px sans-serif;
        }
        .topic-node circle {
            stroke: #e67e22;
            fill: #fff;
        }
        .chapter-node circle {
            stroke: #3498db;
            fill: #fff;
        }
        .root-node circle {
            stroke: #9b59b6;
            fill: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Topic Visualization for {{ pdf_doc.title }}</h2>
        
        <div class="button-container">
            <a href="{% url 'dynamicDB:view_pdf' pdf_doc.pk %}" class="btn">Back to PDF View</a>
            <a href="{% url 'dynamicDB:upload_pdf' %}" class="btn">Upload Another PDF</a>
        </div>
        
        <div class="legend">
            <h3>Legend</h3>
            <div class="legend-item">
                <span class="legend-circle root-node-color" style="background-color: #9b59b6;"></span>
                <span>Document (Root)</span>
            </div>
            <div class="legend-item">
                <span class="legend-circle topic-color"></span>
                <span>Main Topic</span>
            </div>
            <div class="legend-item">
                <span class="legend-circle chapter-color"></span>
                <span>Chapter</span>
            </div>
        </div>
        
        <div id="visualization"></div>
        
        <div id="tooltip" class="tooltip" style="opacity: 0;"></div>
    </div>

    <script>
        // Topic data from Django
        const data = {{ topic_data|safe }};
        
        // Set up visualization dimensions
        const width = document.getElementById('visualization').clientWidth;
        const height = document.getElementById('visualization').clientHeight;
        const radius = Math.min(width, height) / 2 - 100;
        
        // Create SVG container
        const svg = d3.select('#visualization')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .append('g')
            .attr('transform', `translate(${width / 2}, ${height / 2})`);
        
        // Create dendrogram layout
        const tree = d3.cluster()
            .size([360, radius]);
        
        // Create root hierarchy
        const root = d3.hierarchy(data);
        
        // Compute node positions
        tree(root);
        
        // Create tooltip
        const tooltip = d3.select('#tooltip');
        
        // Draw links
        svg.selectAll('.link')
            .data(root.links())
            .enter()
            .append('path')
            .attr('class', 'link')
            .attr('d', d3.linkRadial()
                .angle(d => d.x * Math.PI / 180)
                .radius(d => d.y));
        
        // Draw nodes
        const node = svg.selectAll('.node')
            .data(root.descendants())
            .enter()
            .append('g')
            .attr('class', d => {
                if (d.depth === 0) return 'node-radial root-node';
                if (d.depth === 1) return 'node-radial topic-node';
                return 'node-radial chapter-node';
            })
            .attr('transform', d => {
                return `translate(${radialPoint(d.x, d.y)})`;
            })
            .on('mouseover', function(event, d) {
                let content = '';
                
                if (d.depth === 0) {
                    // Root node (document)
                    content = `<h4>${d.data.name}</h4>
                               <p>Document with ${d.children ? d.children.length : 0} main topics</p>`;
                } else if (d.depth === 1) {
                    // Topic node
                    content = `<h4>${d.data.name}</h4>
                               <p>${d.data.summary || 'No summary available'}</p>
                               <p>Contains ${d.children ? d.children.length : 0} chapters</p>`;
                } else {
                    // Chapter node
                    content = `<h4>${d.data.name}</h4>
                               <p>${d.data.content || 'No content available'}</p>
                               <p>Confidence: ${d.data.value ? (d.data.value * 100).toFixed(1) + '%' : 'N/A'}</p>`;
                }
                
                tooltip.html(content)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY + 10) + 'px')
                    .style('opacity', 1);
            })
            .on('mouseout', function() {
                tooltip.style('opacity', 0);
            });
        
        // Add circles to nodes
        node.append('circle')
            .attr('r', d => {
                if (d.depth === 0) return 10;  // Root node (document)
                if (d.depth === 1) return 8;   // Topic node
                return 6;                      // Chapter node
            });
        
        // Add labels to nodes
        node.append('text')
            .attr('dy', '.31em')
            .attr('x', d => {
                return d.x < 180 ? 15 : -15;
            })
            .attr('text-anchor', d => {
                return d.x < 180 ? 'start' : 'end';
            })
            .attr('transform', d => {
                return d.x < 180 ? null : 'rotate(180)';
            })
            .text(d => {
                // Truncate long names
                const name = d.data.name;
                return name.length > 25 ? name.substring(0, 22) + '...' : name;
            });
        
        // Helper function to convert polar to Cartesian coordinates
        function radialPoint(angle, radius) {
            angle = angle * Math.PI / 180;
            return [radius * Math.cos(angle), radius * Math.sin(angle)];
        }
    </script>
</body>
</html> 